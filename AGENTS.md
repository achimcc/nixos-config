# AGENTS.md - NixOS Configuration Repository

## Overview

This is a NixOS Flake-based system configuration for a personal laptop (`achim-laptop`). It uses Home Manager for user-level configuration and follows a security-focused approach with VPN kill switch, hardened firewall, and privacy-respecting defaults.

## Project Structure

```
nixos-config/
├── flake.nix              # Flake entry point - defines inputs and system configuration
├── flake.lock             # Locked dependency versions (DO NOT .gitignore)
├── configuration.nix      # System-level NixOS configuration
├── hardware-configuration.nix  # Auto-generated hardware config (do not edit manually)
└── home-achim.nix         # User-level Home Manager configuration
```

### File Responsibilities

| File | Purpose |
|------|---------|
| `flake.nix` | Declares inputs (nixpkgs 25.05, home-manager, llm-agents, sops-nix), wires modules together |
| `configuration.nix` | Boot, networking, firewall, desktop (GNOME), system packages, auto-updates |
| `home-achim.nix` | User packages, programs (git, vscode, librewolf, nushell), GPG, dotfiles |
| `hardware-configuration.nix` | Generated by `nixos-generate-config`, contains disk/LUKS/boot config |

## Commands

### Rebuild System (apply changes)

```bash
sudo nixos-rebuild switch --flake /home/achim/nixos-config#achim-laptop
```

### Test Configuration (without switching)

```bash
sudo nixos-rebuild test --flake /home/achim/nixos-config#achim-laptop
```

### Build Without Activating

```bash
sudo nixos-rebuild build --flake /home/achim/nixos-config#achim-laptop
```

### Update Flake Inputs

```bash
nix flake update
```

### Check Flake Syntax

```bash
nix flake check
```

### Format Nix Files

```bash
nixpkgs-fmt *.nix
```

### Garbage Collection (manual)

```bash
sudo nix-collect-garbage -d
```

## Key Patterns & Conventions

### Language

- **Comments and descriptions are in German** - maintain this convention
- Git commit messages are in German

### Nix Style

- Use `with pkgs;` for package lists
- Organize configuration with section headers using `# ==========` style comments
- Use `home.packages` for user tools, `environment.systemPackages` for system-wide tools

### Configuration Structure

1. **System packages** go in `configuration.nix` under `environment.systemPackages`
2. **User packages** go in `home-achim.nix` under `home.packages`
3. **Program configurations** (git, vscode, etc.) use Home Manager's `programs.<name>` options
4. **Services** that need system-level access go in `configuration.nix`
5. **User services** (like gpg-agent) go in `home-achim.nix`

### Flake Input Access

External flake inputs are passed via `specialArgs` to NixOS modules and `extraSpecialArgs` to Home Manager:

```nix
# In flake.nix
specialArgs = { inherit inputs llm-agents; };
home-manager.extraSpecialArgs = { inherit llm-agents; };

# In home-achim.nix - access with:
{ pkgs, llm-agents, ... }:
```

## Security Configuration

### VPN Kill Switch

The firewall is configured as a kill switch - **all traffic is blocked unless it goes through the VPN**:

- Default OUTPUT policy is DROP
- Only VPN interfaces (proton0, tun+, wg+) allow unrestricted outbound traffic
- VPN handshake ports and DHCP/DNS are explicitly allowed
- IPv6 is completely disabled

**Important**: If VPN is disconnected, internet access is intentionally blocked.

### Enabled Security Features

- LUKS full disk encryption
- DNS-over-TLS via systemd-resolved
- Firejail sandbox for Tor Browser
- GPG signing for git commits
- Random MAC address for WiFi scanning
- Telemetry disabled in VSCode and Thunderbird

## Development Setup

### Installed Tools

- **Nix**: nil (language server), nixpkgs-fmt (formatter)
- **Rust**: rustup, rust-analyzer (via VSCode), clippy
- **Shell**: nushell (default shell), starship prompt, carapace completions
- **Editor**: VSCode with extensions for Nix and Rust

### Shell

Default shell is **nushell** (`nu`). Configured aliases:
- `ll` → `ls -l`
- `la` → `ls -a`
- `gs` → `git status`
- `gc` → `git commit`
- `gp` → `git push`

## Gotchas & Important Notes

### DO NOT Modify

- `hardware-configuration.nix` - auto-generated, will be overwritten
- `configuration.nix.save` - backup file, can be deleted

### Flake Lock

- `flake.lock` **must be committed** - it ensures reproducible builds
- The `.gitignore` explicitly notes this

### System Version

- NixOS 25.05 with Home Manager release-25.05
- `system.stateVersion` and `home.stateVersion` are both "24.11" - **do not change these** (tracks initial install version, not current nixpkgs)

### Auto-Updates

System auto-upgrades are enabled (daily at 04:00) but **no automatic reboot**. User decides when to reboot.

### Testing Changes

Always test configuration changes before switching:

```bash
# Check syntax
nix flake check

# Build without activating
sudo nixos-rebuild build --flake .#achim-laptop

# Test (activates but doesn't set as boot default)
sudo nixos-rebuild test --flake .#achim-laptop

# Switch (activates and sets as boot default)
sudo nixos-rebuild switch --flake .#achim-laptop
```

### Rollback

If a configuration breaks the system, select a previous generation from the boot menu (systemd-boot).

### Adding New Flake Inputs

1. Add input in `flake.nix` under `inputs`
2. Add to `outputs` function parameters
3. Pass via `specialArgs` (system) or `extraSpecialArgs` (home-manager)
4. Run `nix flake lock` to update lock file

## Git Conventions

- Commits are GPG-signed by default
- Default branch is `main`
- Pull strategy is rebase
- Commit messages in German, imperative form

## Documentation

**IMPORTANT**: The `README.md` must be updated whenever the configuration changes:

- New modules → Update "Module Structure" section
- New secrets → Expand table in "Secrets Management"
- New applications → Add to "Applications" section
- New keybindings → Update table in "Development Environment"
- Security changes → Adjust "Security Features" section

The README.md serves as the central user documentation and should always be kept up to date.
